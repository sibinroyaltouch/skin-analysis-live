<!DOCTYPE html>
<html>
<head>
    <title>Aestodent 3D Analysis System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- GOOGLE MEDIAPIPE -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #004d40; --accent: #00e5ff; --bg: #f4f6f8; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); text-align: center; color: #333; margin: 0; padding: 20px;}
        
        .screen-container { background: white; max-width: 900px; margin: 0 auto; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

        .camera-wrapper { position: relative; width: 100%; max-width: 500px; margin: 0 auto 20px auto; border-radius: 10px; overflow: hidden; background: black; min-height: 360px; }
        .input_video { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; }
        .output_canvas { width: 100%; height: auto; display: block; border-radius: 10px;}

        .btn-analyze { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 12px 30px; border:none; border-radius: 50px; font-weight: bold; cursor: pointer; }
        .btn-print { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; padding: 12px 30px; border:none; border-radius: 50px; font-weight: bold; cursor: pointer; display: none; }
        .btn-start { background: var(--accent); color: #000; padding: 15px 30px; border:none; border-radius: 50px; font-weight: bold; cursor: pointer; }
        #loader { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: none; }

        .header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; }
        .header img { width: 160px; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 26px; color: var(--primary); margin: 0; }
        .qr-code { width: 60px; height: 60px; background-image: url('https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Aestodent3DScan'); background-size: cover; border: 1px solid #ddd; }

        .patient-details { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 20px; }
        .input-group input, .input-group select { width: 100%; padding: 5px 0; border: none; border-bottom: 1px solid #ccc; font-weight: bold; }

        .gallery-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .gallery-item { position: relative; border: 1px solid #eee; padding: 3px; background: #fff; }
        .gallery-item img { width: 100%; height: 120px; object-fit: cover; }
        .gallery-item p { font-size: 9px; font-weight: bold; color: var(--primary); margin: 4px 0 0 0; text-transform: uppercase; }

        /* FILTERS */
        .filter-bw { filter: grayscale(100%) contrast(150%); }
        .filter-uv { filter: invert(100%) sepia(100%) hue-rotate(190deg) contrast(150%); }
        .filter-thermal { filter: invert(100%) hue-rotate(180deg) contrast(130%) saturate(200%); }
        .filter-brown { filter: sepia(100%) contrast(140%) saturate(150%) hue-rotate(-15deg); }
        .filter-red { filter: grayscale(100%) sepia(100%) hue-rotate(-50deg) saturate(400%); }
        .filter-polarized { filter: contrast(110%) saturate(140%); }
        .filter-glow { filter: invert(100%) sepia(100%) hue-rotate(80deg) brightness(1.1) contrast(1.5) blur(0.5px); }

        .section-title { border-bottom: 2px solid var(--primary); color: var(--primary); text-align: left; font-family: 'Playfair Display', serif; font-size: 18px; margin: 20px 0 10px 0; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; }
        .metric-row { margin-bottom: 10px; }
        .metric-header { display: flex; justify-content: space-between; font-size: 13px; font-weight: bold; }
        .progress-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; font-weight: bold; }
        .badge-mild { background: #28a745; } .badge-mod { background: #ffc107; color: #333; } .badge-sev { background: #dc3545; }

        /* WIREFRAME MAP CONTAINER */
        .scan-container {
            position: relative; width: 100%; max-width: 600px; margin: 0 auto 30px auto;
            border: 2px solid #333; border-radius: 8px; overflow: hidden; background: #000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        #defect-canvas { width: 100%; height: auto; display: block; background: black; }
        .scan-legend { display: flex; justify-content: center; gap: 20px; background: #111; padding: 12px; border-top: 1px solid #333; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: bold; text-transform: uppercase; color: #eee; font-family: 'Roboto', sans-serif; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .dot-acne { background: #ff0000; box-shadow: 0 0 10px #ff0000; }
        .dot-pigment { background: #ffd700; box-shadow: 0 0 10px #ffd700; }
        .dot-circles { background: #00ffff; box-shadow: 0 0 10px #00ffff; }

        .chart-box { height: 200px; width: 100%; }
        .ai-summary-box { background: #eefbfb; border: 1px solid #b2d8d8; padding: 15px; text-align: left; margin-bottom: 20px; border-radius: 5px; font-size: 13px; line-height: 1.6; }
        .rec-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; }
        .footer-info { font-size: 10px; color: #777; margin-top: 30px; border-top: 1px solid #ccc; padding-top: 15px; display: flex; justify-content: space-between; text-align: left; }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); opacity: 0.03; width: 70%; pointer-events: none; z-index: 0; }

        /* PRINT */
        #report-content { display: none; }
        @media print {
            .screen-container, .camera-wrapper { display: none !important; }
            #report-content { display: block !important; }
            .print-page-1 { page-break-after: always; }
            .gallery-item img { height: 110px; }
            input, select, textarea { border: none !important; }
            .chart-box { border: none; height: 190px; }
        }
    </style>
</head>
<body>

    <div class="screen-container">
        <div class="header" style="justify-content: center; border: none;">
            <div style="text-align: center;">
                <img src="/static/logo.jpg" alt="Logo">
                <h1>3D Skin Diagnostics</h1>
                <p>AI-Powered Mesh Topology</p>
            </div>
        </div>

        <div id="loader">Initializing 3D Engine... Allow Camera Access.</div>

        <div class="camera-wrapper">
            <div id="permission-overlay">
                <p style="margin-bottom:20px; color:#ccc;">Camera access required for 3D Mesh Engine.</p>
                <button class="btn-start" onclick="enableCamera()">Start Camera</button>
            </div>
            <video class="input_video" autoplay playsinline></video>
            <canvas class="output_canvas" width="480px" height="360px"></canvas>
        </div>

        <div class="btn-group">
            <button id="capBtn" class="btn-analyze" onclick="captureAndAnalyze()" style="display:none;">üì∏ Capture 3D Scan</button>
            <button class="btn-print" id="printBtn" onclick="window.print()">üñ®Ô∏è Print Report</button>
        </div>
    </div>

    <!-- REPORT CONTENT -->
    <div id="report-content">
        <img src="/static/logo.jpg" class="watermark">

        <!-- PAGE 1 -->
        <div class="print-page-1">
            <div class="header">
                <div class="header-left"><img src="/static/logo.jpg" alt="Logo"><div><h1>Clinical Skin Report</h1><div class="header-sub">ID: <span id="report-id"></span></div></div></div>
                <div class="qr-code"></div>
            </div>

            <div class="patient-details">
                <div class="input-group"><label>Patient Name</label><input type="text" placeholder="Name"></div>
                <div class="input-group"><label>Age</label><input type="number" placeholder="0"></div>
                <div class="input-group"><label>Gender</label><select><option>Female</option><option>Male</option></select></div>
                <div class="input-group"><label>Date</label><input type="text" id="date-field"></div>
            </div>

            <div id="ai-narrative" class="ai-summary-box">Analyzing...</div>

            <h3 class="section-title">üîç Visual Spectrum & 3D Topology</h3>
            <div class="gallery-grid">
                <div class="gallery-item"><img id="img-normal" src=""><p>Natural Light</p></div>
                <div class="gallery-item"><img id="img-mesh" src="" style="border:2px solid #00e5ff"><p>3D Wireframe</p></div>
                <div class="gallery-item"><img id="img-bw" class="filter-bw" src=""><p>Texture</p></div>
                <div class="gallery-item"><img id="img-uv" class="filter-uv" src=""><p>UV Damage</p></div>
                <div class="gallery-item"><img id="img-brown" class="filter-brown" src=""><p>Pigmentation</p></div>
                <div class="gallery-item"><img id="img-red" class="filter-red" src=""><p>Vascularity</p></div>
                <div class="gallery-item"><img id="img-thermal" class="filter-thermal" src=""><p>Inflammation</p></div>
                <div class="gallery-item"><img id="img-glow" class="filter-glow" src=""><p>Porphyrins</p></div>
            </div>

            <h3 class="section-title">üìä Biometric Balance</h3>
            <div class="chart-box" style="height:200px"><canvas id="radarChart"></canvas></div>
        </div>

        <!-- PAGE 2 -->
        <div class="print-page-2">
            <div class="header" style="border: none; padding-bottom: 0;">
                <h2 style="font-size: 18px; color: var(--primary); font-family: 'Playfair Display', serif;">Detailed Analysis & Treatment</h2>
                <div class="qr-code"></div>
            </div>
            <hr style="border:0; border-top:1px solid #ddd; margin-bottom:20px;">

            <h3 class="section-title">üìù Detailed Clinical Metrics</h3>
            <div class="data-grid">
                <div>
                    <div class="metric-row"><div class="metric-header"><span>Health Score</span><span id="health-val">--</span></div><div class="progress-bg"><div id="health-bar" class="progress-fill" style="width:0; background:#28a745;"></div></div></div>
                    <div class="metric-row"><div class="metric-header"><span>Acne Probability</span><span id="acne-val">--</span></div><div class="progress-bg"><div id="acne-bar" class="progress-fill" style="width:0; background:#dc3545;"></div></div></div>
                    <div class="metric-row"><div class="metric-header"><span>Biological Age</span><span id="age-val">--</span></div><div style="font-size:10px; color:#666; font-style:italic;">Based on surface texture</div></div>
                </div>
                <div>
                    <div class="metric-row"><div class="metric-header"><span>Pigmentation</span><span id="stain-val">--</span></div><div class="progress-bg"><div id="stain-bar" class="progress-fill" style="width:0; background:#ffc107;"></div></div></div>
                    <div class="metric-row"><div class="metric-header"><span>Dark Circles</span><span id="circles-val">--</span></div><div class="progress-bg"><div id="circles-bar" class="progress-fill" style="width:0; background:#17a2b8;"></div></div></div>
                    <div class="metric-row"><div class="metric-header"><span>Eye Fatigue</span><span id="fatigue-val">--</span></div><div class="progress-bg"><div id="fatigue-bar" class="progress-fill" style="width:0; background:#6c757d;"></div></div></div>
                </div>
            </div>

            <!-- COMPOSITE DEFECT MAPPING (WIREFRAME ON BLACK) -->
            <h3 class="section-title">üìç Composite Defect Mapping</h3>
            <div class="scan-container">
                <canvas id="defect-canvas"></canvas>
                <div class="scan-legend">
                    <div class="legend-item"><span class="dot dot-acne"></span> Inflammation</div>
                    <div class="legend-item"><span class="dot dot-pigment"></span> Pigmentation</div>
                    <div class="legend-item"><span class="dot dot-circles"></span> Dark Circles</div>
                </div>
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="flex:1;">
                    <h3 class="section-title" style="margin-top:0; font-size:14px;">üß¨ Skin Phototype</h3>
                    <div style="background:#f8f9fa; padding:10px; font-size:11px;">
                        <label><input type="radio" name="fitz" value="1"> Type I</label> <label><input type="radio" name="fitz" value="2"> Type II</label>
                        <label><input type="radio" name="fitz" value="3"> Type III</label> <label><input type="radio" name="fitz" value="4"> Type IV</label>
                        <label><input type="radio" name="fitz" value="5"> Type V</label> <label><input type="radio" name="fitz" value="6"> Type VI</label>
                    </div>
                </div>
                <div style="flex:1;">
                    <h3 class="section-title" style="margin-top:0; font-size:14px;">üìê Clinical Grading</h3>
                    <div style="font-size:12px;">
                        <div><strong>Acne:</strong> <span id="grade-acne" class="badge badge-mild">--</span></div>
                        <div><strong>Pigment:</strong> <span id="grade-stain" class="badge badge-mod">--</span></div>
                        <div><strong>Barrier:</strong> <span id="grade-barrier" class="badge badge-sev">--</span></div>
                    </div>
                </div>
            </div>

            <div id="ai-recommendations" class="rec-box" style="display:none;">
                <div style="font-weight: bold; color: #856404; margin-bottom: 5px;">‚ú® AI Suggested Regimen</div>
                <ul id="rec-list" style="list-style: none; padding: 0; margin: 0;"></ul>
            </div>

            <h3 class="section-title">üíä Prescription (Rx)</h3>
            <table class="rx-table" style="width:100%; border-collapse:collapse; text-align:left; font-size:12px; margin-bottom:10px;">
                <tr style="background:#004d40; color:white;"><th>Medicine</th><th>Dosage</th><th>Freq</th></tr>
                <tr><td><input type="text" style="width:100%"></td><td><input type="text"></td><td><input type="text"></td></tr>
                <tr><td><input type="text" style="width:100%"></td><td><input type="text"></td><td><input type="text"></td></tr>
            </table>
            <textarea style="width:98%; height:40px; border:1px solid #ccc; font-size:12px;" placeholder="Clinical Notes..."></textarea>
            
            <div style="margin-top:15px; text-align:right; border-top:1px solid #000; width:200px; float:right;">Doctor's Signature</div>
            
            <div class="footer-info">
                <div><strong>Aestodent Clinic</strong><br>First Floor, Nahasons Business Complex, Anchappura<br>Parappanangadi P.O, Malappuram</div>
                <div style="text-align: right;"><strong>Contact:</strong> +91 7994135507<br><strong>Email:</strong> aestodent@gmail.com</div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const loader = document.getElementById('loader');
        let radarChartInstance = null;
        let capturedImageOriginal = null;
        let capturedImageMesh = null;
        let currentLandmarks = null;
        let camera = null;

        const ZONES = {
            TZONE: [10, 109, 67, 103, 54, 21, 162, 127, 234, 93, 132, 58, 132, 172, 136, 150, 149, 176, 148, 152, 377, 400, 378, 379, 365, 397, 288, 361, 323, 454, 356, 389, 251, 284, 332, 297, 338],
            CHEEK_LEFT: [330, 347, 346, 352, 376, 433, 280, 425, 427, 266, 329, 349],
            CHEEK_RIGHT: [101, 118, 117, 123, 147, 213, 50, 205, 207, 36, 100, 120],
            EYE_LEFT_BAG: [362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398],
            EYE_RIGHT_BAG: [33, 7, 163, 144, 145, 153, 154, 155, 133, 246, 161, 160, 159, 158, 157, 173]
        };

        function enableCamera() {
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                document.getElementById('permission-overlay').style.display = 'none';
                loader.style.display = 'block';
                startCamera(stream);
            }).catch(err => { alert("Camera blocked."); });
        }

        function startCamera(stream) {
            camera = new Camera(videoElement, {
                onFrame: async () => { await faceMesh.send({image: videoElement}); },
                width: 480, height: 360
            });
            camera.start();
        }

        function onResults(results) {
            loader.style.display = "none";
            document.getElementById('capBtn').style.display = "inline-block";
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            if (results.multiFaceLandmarks) {
                currentLandmarks = results.multiFaceLandmarks[0];
                for (const landmarks of results.multiFaceLandmarks) {
                    drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, {color: '#00e5ff11', lineWidth: 1});
                    drawConnectors(canvasCtx, landmarks, FACEMESH_FACE_OVAL, {color: '#00e5ff', lineWidth: 2});
                }
            }
            canvasCtx.restore();
        }

        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        faceMesh.onResults(onResults);

        // --- CAPTURE ---
        function captureAndAnalyze() {
            // 1. Capture pure Wireframe for Report
            // Temporarily clear canvas to black
            canvasCtx.fillStyle = "black";
            canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
            if(currentLandmarks) {
                drawConnectors(canvasCtx, currentLandmarks, FACEMESH_TESSELATION, {color: '#00e5ff33', lineWidth: 1});
                drawConnectors(canvasCtx, currentLandmarks, FACEMESH_FACE_OVAL, {color: '#00e5ff', lineWidth: 2});
            }
            capturedImageMesh = canvasElement.toDataURL('image/jpeg');
            document.getElementById('img-mesh').src = capturedImageMesh;

            // 2. Capture Raw Image for AI
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = videoElement.videoWidth; tempCanvas.height = videoElement.videoHeight;
            tempCanvas.getContext('2d').drawImage(videoElement, 0, 0);
            capturedImageOriginal = tempCanvas.toDataURL('image/jpeg');

            ['img-normal','img-bw','img-uv','img-brown','img-red','img-thermal','img-glow'].forEach(id => document.getElementById(id).src = capturedImageOriginal);

            alert("3D Scan Captured. Analyzing...");

            fetch('/analyze', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: capturedImageOriginal })
            }).then(response => response.json()).then(data => {
                if(data.success) {
                    const r = data.report;
                    document.getElementById('health-val').innerText = r.health + "%";
                    document.getElementById('acne-val').innerText = r.acne + "%";
                    document.getElementById('circles-val').innerText = r.circles + "%";
                    document.getElementById('stain-val').innerText = r.stain + "%";
                    document.getElementById('fatigue-val').innerText = r.fatigue + "%";
                    document.getElementById('age-val').innerText = r.age + " Yrs";

                    setBar('health-bar', r.health, true);
                    setBar('acne-bar', r.acne, false);
                    setBar('stain-bar', r.stain, false);
                    setBar('circles-bar', r.circles, false);
                    setBar('fatigue-bar', r.fatigue, false);

                    document.getElementById('ai-narrative').innerHTML = `Skin Health Index: <strong>${r.health}%</strong>. Barrier integrity is ${r.health > 70 ? 'intact' : 'compromised'}.`;
                    document.getElementById('grade-acne').innerText = r.acne < 30 ? "Grade I" : "Grade III";
                    document.getElementById('grade-stain').innerText = r.stain < 30 ? "Minimal" : "Visible";
                    document.getElementById('grade-barrier').innerText = r.health > 70 ? "Intact" : "Impaired";

                    // GENERATE WIREFRAME MAP
                    generateWireframeMap(r);
                    generateRecommendations(r);
                    
                    if (radarChartInstance) radarChartInstance.destroy();
                    radarChartInstance = new Chart(document.getElementById('radarChart'), {
                        type: 'radar',
                        data: { labels: ['Health', 'Clarity', 'Tone', 'Radiance'], datasets: [{ label: 'Score', data: [r.health, 100-r.acne, 100-r.stain, 100-r.circles], backgroundColor: '#00e5ff33', borderColor: '#004d40' }] }
                    });

                    document.getElementById('report-content').style.display = 'block';
                    document.getElementById('printBtn').style.display = 'inline-block';
                    document.getElementById('report-content').scrollIntoView({behavior: 'smooth'});
                } else { alert("Analysis Error: " + data.error); }
            }).catch(err => alert("Server Error: " + err));
        }

        // --- MAP GENERATOR (WIREFRAME ON BLACK) ---
        function generateWireframeMap(r) {
            if (!currentLandmarks) return;
            const canvas = document.getElementById('defect-canvas');
            const ctx = canvas.getContext('2d');
            
            // 1. Use the captured MESH image (Black BG + Green Lines) as base
            const img = new Image();
            img.src = capturedImageMesh;
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                ctx.globalCompositeOperation = 'source-over'; 

                // 2. Draw GLOWING Defect Zones on top of wireframe
                if (r.acne > 40) drawBlurredZone(ctx, currentLandmarks, ZONES.TZONE, 'rgba(255, 0, 0, 0.7)', 20);
                
                if (r.circles > 50) {
                    drawBlurredZone(ctx, currentLandmarks, ZONES.EYE_LEFT_BAG, 'rgba(0, 255, 255, 0.7)', 15);
                    drawBlurredZone(ctx, currentLandmarks, ZONES.EYE_RIGHT_BAG, 'rgba(0, 255, 255, 0.7)', 15);
                }
                
                if (r.stain > 50) {
                    drawBlurredZone(ctx, currentLandmarks, ZONES.CHEEK_LEFT, 'rgba(255, 215, 0, 0.6)', 25);
                    drawBlurredZone(ctx, currentLandmarks, ZONES.CHEEK_RIGHT, 'rgba(255, 215, 0, 0.6)', 25);
                }
            };
        }

        function drawBlurredZone(ctx, landmarks, indices, color, blurAmount) {
            ctx.save();
            ctx.beginPath();
            const pt0 = landmarks[indices[0]];
            ctx.moveTo(pt0.x * ctx.canvas.width, pt0.y * ctx.canvas.height);
            for(let i=1; i<indices.length; i++) {
                const pt = landmarks[indices[i]];
                ctx.lineTo(pt.x * ctx.canvas.width, pt.y * ctx.canvas.height);
            }
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.shadowColor = color;
            ctx.shadowBlur = blurAmount;
            ctx.fill();
            ctx.restore();
        }

        function generateRecommendations(r) {
            const list = document.getElementById('rec-list');
            const box = document.getElementById('ai-recommendations');
            list.innerHTML = ""; let found = false;
            if (r.acne > 40) { addRec("Salicylic Acid", "Acne Control"); addRec("Niacinamide", "Inflammation"); found=true; }
            if (r.circles > 50) { addRec("Caffeine Serum", "Dark Circles"); found=true; }
            if (r.health < 60) { addRec("Hyaluronic Acid", "Barrier Repair"); found=true; }
            addRec("SPF 50+ Sunscreen", "Protection");
            box.style.display = found ? 'block' : 'none';
        }
        function addRec(n, r) { const li = document.createElement('li'); li.innerHTML = `<span>${n}</span> <span style="font-size:10px;">${r}</span>`; document.getElementById('rec-list').appendChild(li); }
        function setBar(id, val, highGood) { const el = document.getElementById(id); el.style.width = val + "%"; el.style.backgroundColor = (highGood ? val > 50 : val < 50) ? "#28a745" : "#dc3545"; }
        
        document.getElementById('report-id').innerText = "3D-" + Math.floor(Math.random() * 10000);
        document.getElementById('date-field').value = new Date().toLocaleDateString();
    </script>
</body>
</html>
